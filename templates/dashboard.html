<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>B·∫£ng ƒëi·ªÅu khi·ªÉn L·ªëi s·ªëng t√≠ch c·ª±c</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
</head>
<body>
<div class="container">
    <header class="header">
        <h1>L·ªëi s·ªëng t√≠ch c·ª±c & b·ªÅn v·ªØng</h1>
        <p>Ch√†o m·ª´ng, {{ fullname }}!</p>
    </header>

    <!-- Th·ªùi ti·∫øt -->
    <section class="weather-section">
        <form method="get" class="city-form">
            <label for="city">Ch·ªçn v·ªã tr√≠ hi·ªán t·∫°i:</label>
            <select name="city" required>
                <option value="">-- Ch·ªçn th√†nh ph·ªë --</option>
                {% set cities = [
                    "L√†o Cai", "Tuy√™n Quang", "Lai Ch√¢u", "ƒêi·ªán Bi√™n", "Cao B·∫±ng", "L·∫°ng S∆°n", "S∆°n La", "Th√°i Nguy√™n", "Ph√∫ Th·ªç", "Qu·∫£ng Ninh",
                    "B·∫Øc Ninh", "H∆∞ng Y√™n", "Ninh B√¨nh", "H√† N·ªôi", "H·∫£i Ph√≤ng",
                    "Thanh H√≥a", "Ngh·ªá An", "H√† Tƒ©nh", "Qu·∫£ng Tr·ªã", "Hu·∫ø", "ƒê√† N·∫µng", "Qu·∫£ng Ng√£i", "Gia Lai", "ƒê·∫Øk L·∫Øk", "L√¢m ƒê·ªìng", "Kh√°nh H√≤a",
                    "T√¢y Ninh", "H·ªì Ch√≠ Minh", "ƒê·ªìng Nai", "Vƒ©nh Long", "ƒê·ªìng Th√°p", "C·∫ßn Th∆°", "An Giang", "C√† Mau"
                ] %}
                {% for city in cities %}
                    <option value="{{ city }}" {% if weather_city == city %}selected{% endif %}>{{ city }}</option>
                {% endfor %}
            </select>
            <button type="submit" class="btn">X√°c nh·∫≠n</button>
        </form>

        {% if weather %}
            <div class="weather-info">
                <h3>Th·ªùi ti·∫øt hi·ªán t·∫°i t·∫°i {{ weather_city }}:</h3>
                <p>{{ weather.desc }} - {{ weather.temp }}¬∞C</p>
                <img src="https://openweathermap.org/img/wn/{{ weather.icon }}.png" alt="icon">
            </div>
        {% else %}
            <p>Ch∆∞a ch·ªçn th√†nh ph·ªë ho·∫∑c kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu th·ªùi ti·∫øt.</p>
        {% endif %}
    </section>

    <!-- G·ª£i √Ω t·ª´ AI -->
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <section class="ai-suggestion">
                {% for msg in messages %}
                    <div class="ai-box">
                        ü§ñ <strong>G·ª£i √Ω t·ª´ AI:</strong> {{ msg }}
                    </div>
                {% endfor %}
            </section>
        {% endif %}
    {% endwith %}

    <!-- N·ªôi dung b·∫£n tin -->
    <section class="content-section">
        <h2>B·∫£n tin v·ªÅ m√¥i tr∆∞·ªùng & s·ª©c kh·ªèe</h2>
        {% if contents and contents|length > 0 %}
            <ul class="content-list">
                {% for content in contents %}
                    {% if content is sequence and content|length > 1 %}
                        <li>
                            <h4>{{ content[0] }}</h4>
                            <p>{{ content[1][:120] }}...</p>
                        </li>
                    {% else %}
                        <li>D·ªØ li·ªáu b·∫£n tin kh√¥ng h·ª£p l·ªá.</li>
                    {% endif %}
                {% endfor %}
            </ul>
        {% else %}
            <p>Ch∆∞a c√≥ b·∫£n tin n√†o.</p>
        {% endif %}
    </section>

    <!-- Th√≥i quen ch∆∞a ho√†n th√†nh -->
    <section class="habit-section">
        <h2>Th√≥i quen ch∆∞a ho√†n th√†nh h√¥m nay</h2>
        {% if pending_habits and pending_habits|length > 0 %}
            <ul class="habit-list">
                {% for habit in pending_habits %}
                    {% if habit is mapping and habit.get('name') %}
                        <li class="habit-item">
                            <div class="habit-info">
                                <strong>{{ habit.name }}</strong><br>
                                <small>M√¥ t·∫£: {{ habit.description|default('Ch∆∞a c√≥') }}</small><br>
                                <small>Th·ªùi l∆∞·ª£ng: {{ habit.target_duration|default(0) }} ph√∫t</small><br>
                                <small>
                                    Gi·ªù th·ª±c hi·ªán:
                                    {% set t = habit.time_of_day.split(":") if habit.time_of_day else ['09', '00'] %}
                                    {% if t|length >= 2 %}
                                        {% set hour = t[0]|int %}
                                        {% set minute = t[1]|int %}
                                        {% if hour == 0 %}
                                            12:{{ "%02d"|format(minute) }} AM
                                        {% elif hour < 12 %}
                                            {{ "%02d"|format(hour) }}:{{ "%02d"|format(minute) }} AM
                                        {% elif hour == 12 %}
                                            12:{{ "%02d"|format(minute) }} PM
                                        {% else %}
                                            {{ "%02d"|format(hour - 12) }}:{{ "%02d"|format(minute) }} PM
                                        {% endif %}
                                    {% else %}
                                        {{ habit.time_of_day|default('09:00') }} (ƒê·ªãnh d·∫°ng gi·ªù kh√¥ng h·ª£p l·ªá)
                                    {% endif %}
                                </small><br>
                                <small>D·ª± ki·∫øn ho√†n th√†nh: {{ habit.expected_completion|default('09:30') }}</small><br>
                                <small>Th·ªùi ti·∫øt: {{ habit.weather_condition|default('Kh√¥ng r√µ') }}</small><br>
                                <small>ƒê√°nh gi√°: {{ habit.evaluation|default('Ch∆∞a ƒë√°nh gi√°') }}</small><br>
                                <small>L·ªùi khuy√™n: {{ habit.advice|default('Chu·∫©n b·ªã ƒë·∫ßy ƒë·ªß') }}</small>
                            </div>
                            <form method="post" action="{{ url_for('track_habit', habit_id=habit.id|default(0)) }}">
                                <button type="submit" name="start" class="btn-start">B·∫Øt ƒë·∫ßu</button>
                                <button type="submit" name="complete" class="btn-complete">Ho√†n th√†nh</button>
                            </form>
                        </li>
                    {% else %}
                        <li>D·ªØ li·ªáu th√≥i quen kh√¥ng h·ª£p l·ªá: {{ habit }}</li>
                    {% endif %}
                {% endfor %}
            </ul>
        {% else %}
            <p>B·∫°n ƒë√£ ho√†n th√†nh h·∫øt c√°c th√≥i quen h√¥m nay!</p>
        {% endif %}

        <a href="{{ url_for('create_habit', user_id=user_id, city=weather_city) }}" class="btn btn-primary">T·∫°o th√≥i quen m·ªõi</a>
        <button id="suggestHabitBtn" class="btn btn-secondary" data-city="{{ weather_city }}">ü§ñ G·ª£i √Ω th√≥i quen t·ª´ AI</button>
    </section>

    <!-- Th√≥i quen ƒë√£ ho√†n th√†nh -->
    <section class="habit-section">
        <h2>Th√≥i quen ƒë√£ ho√†n th√†nh h√¥m nay ‚úÖ</h2>
        {% if completed_habits and completed_habits|length > 0 %}
            <ul class="habit-list completed">
                {% for habit in completed_habits %}
                    {% if habit is mapping and habit.get('name') %}
                        <li class="habit-item">
                            <div class="habit-info">
                                <strong>{{ habit.name }}</strong>
                                <span>
                                    {% set t = habit.time_of_day.split(":") %}
                                    {% if t|length >= 2 %}
                                        {% set hour = t[0]|int %}
                                        {% set minute = t[1] %}
                                        {% if hour == 0 %}
                                            12:{{ minute }} AM
                                        {% elif hour < 12 %}
                                            {{ "%02d"|format(hour) }}:{{ minute }} AM
                                        {% elif hour == 12 %}
                                            12:{{ minute }} PM
                                        {% else %}
                                            {{ "%02d"|format(hour - 12) }}:{{ minute }} PM
                                        {% endif %}
                                    {% else %}
                                        {{ habit.time_of_day }} (ƒê·ªãnh d·∫°ng gi·ªù kh√¥ng h·ª£p l·ªá)
                                    {% endif %}
                                </span>
                            </div>
                            <span class="completed-label">‚úÖ ƒê√£ ho√†n th√†nh</span>
                        </li>
                    {% else %}
                        <li>D·ªØ li·ªáu th√≥i quen kh√¥ng h·ª£p l·ªá.</li>
                    {% endif %}
                {% endfor %}
            </ul>
        {% else %}
            <p>Ch∆∞a c√≥ th√≥i quen n√†o ƒë∆∞·ª£c ho√†n th√†nh h√¥m nay.</p>
        {% endif %}
    </section>

    <footer class="footer">
        <a href="{{ url_for('logout') }}" class="btn btn-logout">ƒêƒÉng xu·∫•t</a>
    </footer>
</div>

<script>
    // G·ª≠i y√™u c·∫ßu t·∫°o m·ªôt th√≥i quen ng·∫´u nhi√™n
    document.getElementById("suggestHabitBtn").onclick = function () {
        const city = this.getAttribute("data-city");
        if (!city) {
            alert("Vui l√≤ng ch·ªçn th√†nh ph·ªë tr∆∞·ªõc khi g·ª£i √Ω th√≥i quen.");
            return;
        }

        document.getElementById("suggestHabitBtn").disabled = true;
        document.getElementById("suggestHabitBtn").innerText = "ƒêang t·∫°o...";

        fetch("{{ url_for('suggest_habit', user_id=user_id) }}", {
            method: "POST",
            headers: {
                "X-Requested-With": "XMLHttpRequest",
                "Content-Type": "application/x-www-form-urlencoded",
            },
            body: `city=${encodeURIComponent(city)}`
        })
        .then(async response => {
            document.getElementById("suggestHabitBtn").disabled = false;
            document.getElementById("suggestHabitBtn").innerText = "ü§ñ G·ª£i √Ω th√≥i quen t·ª´ AI";
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.includes("application/json")) {
                const data = await response.json();
                if (data.success) {
                    alert("‚úÖ ƒê√£ t·∫°o th√≥i quen t·ª´ AI!");
                    location.reload();
                } else {
                    alert("‚ùå L·ªói khi t·∫°o th√≥i quen: " + (data.error || "Kh√¥ng r√µ"));
                }
            } else {
                const text = await response.text();
                console.error("‚ö†Ô∏è Ph·∫£n h·ªìi kh√¥ng ph·∫£i JSON:", text);
                alert("‚ùå Server tr·∫£ v·ªÅ n·ªôi dung kh√¥ng h·ª£p l·ªá:\n" + text.slice(0, 200));
            }
        })
        .catch(error => {
            document.getElementById("suggestHabitBtn").disabled = false;
            document.getElementById("suggestHabitBtn").innerText = "ü§ñ G·ª£i √Ω th√≥i quen t·ª´ AI";
            console.error("Fetch error:", error);
            alert("‚ùå L·ªói k·∫øt n·ªëi m√°y ch·ªß: " + error.message);
        });
    };
</script>

</body>
</html>